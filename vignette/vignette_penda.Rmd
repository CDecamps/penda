---
title: "Presentation of Penda"
author: "Clémentine Decamps"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
source("~/projects/penda/R/simu.R")
source("~/projects/penda/R/ranking.R")
source("~/projects/penda/R/testing.R")

```



##Data processing

We import the control data, and we take 1000 genes for the 98 patients.
The five last patients are used to simulate deregulation data.
The function "detect_zero_value" was used before to eliminates genes with more than 99% of expression value under 10.
```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}
ctrl_data = readRDS('~/projects/perso_DA/data_ctrl_process.rds')[1:1000,]

simu_data = ctrl_data[,94:98]
ctrl_data = ctrl_data[,-(94:98)]

```


##Ranking in control

The function "find_D_U_ctrl" returns two matrix. For each gene in columns, the row gene is 
"TRUE" if is **D**own-expresed or **U**p-expressed.

```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

D_U_ctrl = find_D_U_ctrl(ctrl_data, 0.01, 4, 0.9)
table(D_U_ctrl$D)
table(D_U_ctrl$U)

check_D_U (D_U_ctrl, ctrl_data, 0.9)

```

##Simulation of dysregulation of gene expression

"simu_data" is the gene expression of two control genes. The function "dysreg_simulation" randomnly dysregul about 30% of these expressions.

```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

dysreg_data = dysreg_simulation(simu_data, 0.4, 60)
table(simu_data != dysreg_data)

```


##Test of the deregulation


```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}


D_matrix = dysreg_data
U_matrix = dysreg_data
for (p in 1:3){
  D_U = test_individu(ctrl_data, dysreg_data[,p], 0.05, 20, D_U_ctrl, 0.1)
  D_matrix[,p] = unlist(D_U[1])
  U_matrix[,p] = unlist(D_U[2])
}

sum(U_matrix[,1])
sum(D_matrix[,1])
sum(U_matrix[,2])
sum(D_matrix[,2])
sum(U_matrix[,3])
sum(D_matrix[,3])
```

##Representation
!! en cours de développement !!

```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}



representation_fdr = function(D_matrix, U_matrix, simu_data, dysreg_data){
  #True positive = true down + true up
  TP = (length (which(simu_data > dysreg_data & D_matrix == 1)) 
        + length (which(simu_data < dysreg_data & U_matrix == 1)))
  
  #False positive = down ou up alors que pas bougé
  FP = (length (which(simu_data == dysreg_data & D_matrix == 1)) 
        + length (which(simu_data == dysreg_data & U_matrix == 1)))

  #False negative = pas bougé alors que down ou up
  FN = (length (which(simu_data < dysreg_data & D_matrix == 0 & U_matrix == 0)) 
        + length (which(simu_data > dysreg_data & D_matrix == 0 & U_matrix == 0)))

  #TN = true pas bougé
  TN = (length (which(simu_data == dysreg_data & D_matrix == 0 & U_matrix == 0)) 
        + length (which(simu_data == dysreg_data & D_matrix == 0 & U_matrix == 0)))

  df= data.frame(type = c("TP","FP","FN","TN", "FDR"), results=c(TP, FP, FN, TN, (FP/(TP+FP))))
  library(ggplot2)
  ggplot(df, aes(x=type, y=results, fill=type)) + geom_bar(stat="identity") + geom_text(aes(label=results), vjust=1)

  
}

resultsP1 = representation_fdr(D_matrix[,1], U_matrix[,1], simu_data[,1], dysreg_data[,1])
resultsP2 = representation_fdr(D_matrix[,2], U_matrix[,2], simu_data[,2], dysreg_data[,2])
resultsP3 = representation_fdr(D_matrix[,3], U_matrix[,3], simu_data[,3], dysreg_data[,3])

resultsP1
resultsP2
resultsP3

#Certains taux de fdr élevés

#Mais quand on fait le test individu sur la donnée de base (non dérégulée) par rapport aux autres contrôles...
D_matrix_simu = simu_data
U_matrix_simu = simu_data
for (p in 1:3){
  D_U = test_individu(ctrl_data, simu_data[,p], 0.05, 20, D_U_ctrl, 0.1)
  D_matrix_simu[,p] = unlist(D_U[1])
  U_matrix_simu[,p] = unlist(D_U[2])
}

#Patient 1, gènes Up et Down
sum(U_matrix_simu[,1])
sum(D_matrix_simu[,1])
#Patient 2, gènes Up et Down
sum(U_matrix_simu[,2])
sum(D_matrix_simu[,2])
#Patient 3, gènes Up et Down
sum(U_matrix_simu[,3])
sum(D_matrix_simu[,3])

#La variation de l'expression intra-patients contrôles n'est pas très bien gérée par les tests (résultats sur 588 gènes, 45 gènes ~= 7.5%)

```
