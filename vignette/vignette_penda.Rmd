---
title: "Presentation of Penda"
author: "Clémentine Decamps"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
source("~/projects/penda/R/simu.R")
source("~/projects/penda/R/ranking.R")
source("~/projects/penda/R/testing.R")

```



##Data processing

We import the control data, and we take 1000 genes for the 98 patients.
The five last patients are used to simulate deregulation data.
The function "detect_zero_value" was used before to eliminates genes with more than 99% of expression value under 10.
```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}
ctrl_data = readRDS('~/projects/perso_DA/data_ctrl_process.rds')[1:1000,]

simu_data = ctrl_data[,94:98]
colnames(simu_data) = c("P1","P2","P3","P4","P5")

ctrl_data = ctrl_data[,-(94:98)]


```


##Ranking in control

The function "find_D_U_ctrl" returns two matrix. For each gene in columns, the row gene is 
"TRUE" if is **D**own-expresed or **U**p-expressed.

```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

# D_U_ctrl = find_D_U_ctrl(ctrl_data, 0.001, 4, 0.99)
# table(D_U_ctrl$D)
# table(D_U_ctrl$U)
# saveRDS(D_U_ctrl, "D_U_93p.rds")
D_U_ctrl = readRDS("D_U_93p.rds")
D_U_ctrl$D = D_U_ctrl$D[1:1000,1:1000]
D_U_ctrl$U = D_U_ctrl$U[1:1000,1:1000]

check_D_U (D_U_ctrl, ctrl_data, 0.99)

```

##Simulation of dysregulation of gene expression

"simu_data" is the gene expression of two control genes. The function "dysreg_simulation" randomnly dysregul 40% of these expressions.

```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

simulation = dysreg_simulation(simu_data, 0.4, 60)
table(simulation$initial_data != simulation$simulated_data)
length(simulation$changes_index)
```


##Test of the deregulation


```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

D_matrix_l0 = simulation$simulated_data
U_matrix_l0 = simulation$simulated_data
for(p in 1:1){
  D_U_l0 = test_individu(ctrl_data, simulation$simulated_data[,p], 0.03, 20, D_U_ctrl, 0.2)
  D_matrix_l0[,p] = unlist(D_U_l0[1])
  U_matrix_l0[,p] = unlist(D_U_l0[2])
}

D_matrix_sans_l0 = simulation$simulated_data
U_matrix_sans_l0 = simulation$simulated_data
for(p in 1:1){
  D_U_sans_l0 = test_individu_sans_l0(ctrl_data, simulation$simulated_data[,p], 0.03, 20, D_U_ctrl, 0.2)
  D_matrix_sans_l0[,p] = unlist(D_U_sans_l0[1])
  U_matrix_sans_l0[,p] = unlist(D_U_sans_l0[2])
}

D_matrix_l0_reduit = simulation$simulated_data
U_matrix_l0_reduit = simulation$simulated_data
for(p in 1:1){
  D_U_l0_reduit = test_individu(ctrl_data, simulation$simulated_data[,p], 0.01, 20, D_U_ctrl, 0.2)
  D_matrix_l0_reduit[,p] = unlist(D_U_l0_reduit[1])
  U_matrix_l0_reduit[,p] = unlist(D_U_l0_reduit[2])
}

D_matrix_sansi = simulation$simulated_data
U_matrix_sansi = simulation$simulated_data
for(p in 1:1){
  D_U_sansi = test_individu_sans_i(ctrl_data, simulation$simulated_data[,p], 0.01, 20, D_U_ctrl, 0.2)
  D_matrix_sansi[,p] = unlist(D_U_sansi[1])
  U_matrix_sansi[,p] = unlist(D_U_sansi[2])
}

# saveRDS(D_matrix, "D_matrix.rds")
# saveRDS(U_matrix, "U_matrix.rds")
#Nb of down genes
#colSums(D_matrix)
#Nb of up genes
#colSums(U_matrix)
```

##Representation
!! en cours de développement !!

```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}


#Représentation des résultats avec ou sans l0, avec ou sans itérations

p1_l0 = results_simulation(D_matrix_l0, U_matrix_l0, simulation)
p1_sans_l0 = results_simulation(D_matrix_sans_l0, U_matrix_sans_l0, simulation)
p1_l0_reduit = results_simulation(D_matrix_l0_reduit, U_matrix_l0_reduit, simulation)
p1_sansi  = results_simulation(D_matrix_sansi, U_matrix_sansi, simulation)

dessin = function(results){
  FP = results$FP
  df= data.frame(type = c("TP","FP","FN","TN", "FDR"), results=c(unlist(results), (results$FP / (results$TP + results$FP))))
  library(ggplot2)
  ggplot(df, aes(x=type, y=results, fill=type)) + geom_bar(stat="identity") + geom_text(aes(label=results), vjust=1)
}


dessin(p1_l0)
dessin(p1_sans_l0)
dessin(p1_l0_reduit)
dessin(p1_sansi)


#Représentation des différences

df_l0_ou_pas_p1 = data.frame( 
              l0 = factor(rep(c("quantile l0 = 0.03","quantile l0 = 0.01", "sans l0", "sans itération"), each = 4)),
              type = factor(rep(c("TP","FP", "FN", "TN"), times = 4)),
              nbresults = unlist(c(p1_l0, p1_l0_reduit, p1_sans_l0, p1_sansi))
)

library(ggplot2)
  ggplot(df_l0_ou_pas_p1, aes(x=l0, y=nbresults, fill=type)) + geom_bar(stat="identity", position=position_dodge()) + geom_text(aes(label=nbresults), vjust=-0.2, position = position_dodge(0.9))



  
```



Simulation complexe

Test avec la loi normale

n = function(x, u, a){
  (1/(a*sqrt(2*pi))) * exp(-(((x-u)^2)/(2*a^2)))
}
x = seq(-20, 20, 0.05)
y = n(x, 0, 1)
 y1 <- cumsum(y)*diff(x)[1] #cumul

 pf <- approxfun(x,y1) #cumulative density function
 qf <- approxfun(y1,x) #quantile function
 rf <- function(n) qf(runif(n)) #randome variable

```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

#P1
x=seq(0, 100, 0.1)

test = get_random_variable(p1, x, nb_r=10000)
test = get_random_variable(p2, x, nb_r=10000)

xm=seq(0, 500, 0.5)

test = get_random_variable(p3, xm, nb_r=10000)

simulation = dysreg_simulation(simu_data[,1], 0.2, 60)
simulation2 = simu_v2(simu_data[,1])
summary(simulation)
summary(simulation2)

D_U = test_individu(ctrl_data, simulation$simulated_data, 0.03, 20, D_U_ctrl, 0.2)
D_simu1 = unlist(D_U[1])
U_simu1 = unlist(D_U[2])

D_U = test_individu(ctrl_data, simulation2$simulated_data, 0.03, 20, D_U_ctrl, 0.2)
D_simu2 = unlist(D_U[1])
U_simu2 = unlist(D_U[2])

results_simu1 = results_simulation(D_simu1, U_simu1, simulation)
results_simu2 = results_simulation(D_simu2, U_simu2, simulation2)

dessin(results_simu1)
dessin(results_simu2)
```
