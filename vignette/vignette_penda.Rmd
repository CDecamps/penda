---
title: "Presentation of Penda"
author: "Cl√©mentine Decamps"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
source("~/projects/penda/R/simu.R")
source("~/projects/penda/R/ranking.R")
source("~/projects/penda/R/testing.R")

```



##Data processing

We import the control data, and we take 1000 genes for the 98 patients.
The five last patients are used to simulate deregulation data.
The function "detect_zero_value" was used before to eliminates genes with more than 99% of expression value under 10.
```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}
ctrl_data = readRDS('~/projects/perso_DA/data_ctrl_process.rds')[1:1000,]
simu_data = ctrl_data[,94:98]
colnames(simu_data) = c("P1","P2","P3","P4","P5")

ctrl_data = ctrl_data[,-(94:98)]
```


##Ranking in control

We used the function "find_D_U_ctrl" which returns two matrix. For each gene in columns, the row gene is "TRUE" if is **D**own-expresed or **U**p-expressed.
The limit is between the quantile 0.001/4 and the quantile 0.999*4. 99% of patients must be in the conditions.
The function "check_D_U" checks if not exists genes both up and down expressed, and for each gene :
- if the maximal down gene is less expressed in 99% of controls.
- if the minimal up gene is more expressed in 99 % of controls.


```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

D_U_ctrl = find_D_U_ctrl(ctrl_data, 0.001, 4, 0.99)
table(D_U_ctrl$D)
table(D_U_ctrl$U)

check_D_U (D_U_ctrl, ctrl_data, 0.99)

```

##Simulation of dysregulation of gene expression

We want to dysregul genes of 3 control patients in "simu_data" to simulate a cancer dysregulation.
The function "simplified_simulation" randomly dysreguls a given proportion of genes expressions. Here, we choose 30% of genes.
We do the simulation on 3 patients, and then we concatenate the results.

```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

simup1 = simplified_simulation(simu_data[,1], 0.3)
simup2 = simplified_simulation(simu_data[,2], 0.3)
simup3 = simplified_simulation(simu_data[,3], 0.3)
simulation = list()

simulation$simulated_data = matrix(c(simup1$simulated_data, simup2$simulated_data, simup3$simulated_data), ncol=3, dimnames = list(rownames(simu_data)))
simulation$initial_data = matrix(c(simup1$initial_data, simup2$initial_data, simup3$initial_data), ncol=3, dimnames = list(rownames(simu_data)))
simulation$changes_idx = matrix(c(simup1$changes_idx, simup2$changes_idx, simup3$changes_idx), ncol=3)

table(simulation$initial_data != simulation$simulated_data)
length(simulation$changes_idx)
```


#Test of the deregulation

We make the dysregulation for the 3 patients. 
The quantile of l0 is 0.03, it means that genes at the extremities of expression distribution (under 3% or above 97%) are not used in the control list.
0.2 is the threshold for the dysregulation.

Please be careful to have gene names as row names in your datas. 
```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

D_matrix = simulation$simulated_data
U_matrix = simulation$simulated_data
for(p in 1:3){
  print(c("Patient number",p))
  D_U = patient_test(ctrl_data, simulation$simulated_data[,p], 0.03, 20, D_U_ctrl, 0.2)
  D_matrix[,p] = unlist(D_U[1])
  U_matrix[,p] = unlist(D_U[2])
}

#Number of predicted down-regulated genes
colSums(D_matrix)
#Number of predicted up-regulated genes
colSums(U_matrix)
```

#Representation

The function "results_simulation" computes the number of false positive, true positive, false negative and false positive results from the test and the original datas.
The function "draw_results" make an histogram with these results.

```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

results = results_simulation(D_matrix, U_matrix, simulation)

draw_results(results)
```



##Complex simulation 

Complex_simulation used the real distribution of dyresgulation in our cancers to makes the simulation.
We want to dysregul genes of 3 control patients in "simu_data" to simulate a cancer dysregulation.
We do the simulation on 3 patients, and then we concatenate the results.

```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

csimup1 = complex_simulation(simu_data[,1])
csimup2 = complex_simulation(simu_data[,2])
csimup3 = complex_simulation(simu_data[,3])
csimulation = list()

csimulation$simulated_data = matrix(c(csimup1$simulated_data, csimup2$simulated_data, csimup3$simulated_data), ncol=3, dimnames = list(rownames(simu_data)))
csimulation$initial_data = matrix(c(csimup1$initial_data, csimup2$initial_data, csimup3$initial_data), ncol=3, dimnames = list(rownames(simu_data)))
csimulation$changes_idx = list(csimup1$changes_idx, csimup2$changes_idx, csimup3$changes_idx)

table(csimulation$initial_data != csimulation$simulated_data)

```

#Test of the deregulation

We make the dysregulation for the 3 patients with a complex simulation. 

Please be careful to have gene names as row names in your datas. 
```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

D_matrixc = csimulation$simulated_data
U_matrixc = csimulation$simulated_data
for(p in 1:3){
  print(c("Patient number",p))
  D_U = patient_test(ctrl_data, csimulation$simulated_data[,p], 0.03, 20, D_U_ctrl, 0.2)
  D_matrixc[,p] = unlist(D_U[1])
  U_matrixc[,p] = unlist(D_U[2])
}

#Number of predicted down-regulated genes
colSums(D_matrixc)
#Number of predicted up-regulated genes
colSums(U_matrixc)
```

#Representation

The function "results_simulation" computes the number of false positive, true positive, false negative and false positive results from the test and the original datas.
The function "draw_results" make an histogram with these results.

```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

resultsc = results_simulation(D_matrixc, U_matrixc, csimulation)

draw_results(resultsc)
```
