---
title: "Presentation of Penda"
author: "Clémentine Decamps"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
# source("./R/simu.R")
# source("./R/ranking.R")
# source("./R/testing.R")

```



##Data processing

We import the control data, and we take 150 genes for the 98 patients.
The two last patients are used to simulate deregulation data.
The function "detect_zero_value" allows to eliminate genes with more than 80% of expression equal to 0.
The processed data has 104 genes.
```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}
ctrl_data = readRDS('~/projects/perso_DA/data_ctrl.rds')[1:150,]
simu_data = ctrl_data[,97:98]
ctrl_data = ctrl_data[,-(97:98)]

null_values = detect_zero_value(ctrl_data, simu_data, 0.8)
ctrl_data = ctrl_data[!null_values,]
simu_data = simu_data[!null_values,]

```


##Ranking in control

The function "find_D_U_ctrl" returns two matrix. For each gene in columns, the row gene is 
"TRUE" if is **D**own-expresed or **U**p-expressed.

```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

D_U_ctrl = find_D_U_ctrl(ctrl_data, 0.01, 30, 0.8)
table(D_U_ctrl$D)
table(D_U_ctrl$U)

```

##Simulation of dysregulation of gene expression

"simu_data" is the gene expression of two control genes. The function "dysreg_simulation" randomnly dysregul about 30% of these expressions.

```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

dysreg_data = dysreg_simulation(simu_data, 0.3, 60)
table(simu_data != dysreg_data)

```


##Test of the deregulation


```{r, tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=55)}

D_matrix = dysreg_data
U_matrix = dysreg_data
for (p in 1:2){
  D_U = test_individu(ctrl_data, dysreg_data[,p], 0.05, 3, D_U_ctrl, 0.1)
  D_matrix[,p] = unlist(D_U[1])
  U_matrix[,p] = unlist(D_U[2])
}


representation_fdr = function(D_matrix, U_matrix, simu_data, dysreg_data){
  #True positive = true down + true up
  TP = (length (which(simu_data > dysreg_data & D_matrix == 1)) 
        + length (which(simu_data < dysreg_data & U_matrix == 1)))
  
  #False positive = down ou up alors que pas bougé
  FP = (length (which(simu_data == dysreg_data & D_matrix == 1)) 
        + length (which(simu_data == dysreg_data & U_matrix == 1)))

  #False negative = pas bougé alors que down ou up
  FN = (length (which(simu_data < dysreg_data & D_matrix == 0 & U_matrix == 0)) 
        + length (which(simu_data > dysreg_data & D_matrix == 0 & U_matrix == 0)))

  #TN = true pas bougé
  TN = (length (which(simu_data == dysreg_data & D_matrix == 0 & U_matrix == 0)) 
        + length (which(simu_data == dysreg_data & D_matrix == 0 & U_matrix == 0)))
  #return(c(TP, FP, FN, TN))
  df= data.frame(type = c("TP","FP","FN","TN", "FDR"), results=c(TP, FP, FN, TN, (FP/(TP+FP))))
  library(ggplot2)
  ggplot(df, aes(x=type, y=results, fill=type)) + geom_bar(stat="identity") + geom_text(aes(label=results), vjust=1)

  
}

resultsP1 = representation_fdr(D_matrix[,1], U_matrix[,1], simu_data[,1], dysreg_data[,1])
resultsP2 = representation_fdr(D_matrix[,2], U_matrix[,2], simu_data[,2], dysreg_data[,2])

resultsP1
resultsP2

```
